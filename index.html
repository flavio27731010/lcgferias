<!DOCTYPE html>
<html lang="pt-BR">
<head>

<!-- PWA -->
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-512.png">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de F√©rias</title>

<style>
body { font-family: Arial, sans-serif; padding: 15px; }
.controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; }
.campo { display: flex; flex-direction: column; }
label { font-size: 12px; font-weight: bold; }
input, select, button { padding: 6px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #f0f0f0; }
.hoje { background: #0d47a1 !important; color: white; font-weight: bold; }
.box { border: 1px solid #ccc; padding: 10px; margin-top: 15px; }
.proximo { background: #e3f2fd; border-left: 6px solid #0d47a1; }
.proximos-container { display: flex; gap: 10px; flex-wrap: wrap; }
.proximo-card { background: white; border: 1px solid #bbb; padding: 8px; min-width: 180px; border-radius: 4px; text-align: center; }
.chip { display: inline-block; padding: 3px 8px; margin: 2px; border-radius: 12px; color: white; font-size: 12px; font-weight: bold; }
</style>
</head>

<body>

<h2>CONTROLE DE F√âRIAS</h2>

<!-- ADMIN -->
<div class="box">
    <button id="btnMostrarAdmin">üîê Entrar como administrador</button>

    <div id="loginAdmin" style="display:none;margin-top:10px;">
        <h3>Login Administrador</h3>

        <div class="controls">
            <div class="campo">
                <label>Usu√°rio</label>
                <input type="text" id="usuario">
            </div>

            <div class="campo">
                <label>Senha</label>
                <input type="password" id="senha">
            </div>

            <button id="btnLogin">Entrar</button>
            <button id="btnLogout">Sair</button>
        </div>

        <div id="statusLogin" style="margin-top:5px;font-weight:bold;color:#0d47a1"></div>
    </div>
</div>

<!-- FILTRO DE DATAS -->
<div class="controls">
    <div class="campo">
        <label>Filtrar Status</label>
        <select id="filtroDisponivel">
            <option value="todos">Todos</option>
            <option value="disponivel">Dispon√≠veis</option>
            <option value="ferias">Em F√©rias</option>
        </select>
    </div>
</div>

<!-- FORM -->
<div class="controls">
    <div class="campo">
        <label>Nome*</label>
        <input type="text" id="nome">
    </div>

    <div class="campo">
        <label>Data inicial*</label>
        <input type="date" id="inicio">
    </div>

    <div class="campo">
        <label>Data final*</label>
        <input type="date" id="fim">
    </div>

    <div class="campo">
        <label>Tem feriado na jornada?</label>
        <select id="temFeriado">
            <option value="nao">N√£o</option>
            <option value="sim">Sim</option>
        </select>
    </div>

    <div class="campo" id="campoQtdFeriado" style="display:none">
        <label>Qtd. de feriados</label>
        <input type="number" id="qtdFeriado" min="1" value="1">
    </div>

    <div class="campo">
        <label>Retorno de f√©rias</label>
        <input type="date" id="retorno" disabled>
    </div>

    <button id="btnSalvar">Marcar F√©rias</button>
    <button id="btnCancelar">Cancelar edi√ß√£o</button>
</div>

<div class="box proximo">
    <h3>Pr√≥ximos a tirar f√©rias</h3>
    <div id="proximoFerias" class="proximos-container"></div>
</div>

<div class="box">
    <h3>Per√≠odos cadastrados</h3>
    <ul id="listaPessoas" style="list-style:none;padding:0;"></ul>
</div>

<table>
<thead>
<tr>
    <th>Data</th>
    <th>Dia da Semana</th>
    <th>Status</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<script>
/* ===== ADMINS ===== */
const ADMINS = [
    { user: "flavio", pass: "126683" },
    { user: "andiara", pass: "126621" },
    { user: "ana", pass: "124904" },
    { user: "caio", pass: "126675" }
];

/* ===== ELEMENTOS ===== */
const btnMostrarAdmin = document.getElementById("btnMostrarAdmin");
const loginAdminDiv = document.getElementById("loginAdmin");
const statusLogin = document.getElementById("statusLogin");
const usuario = document.getElementById("usuario");
const senha = document.getElementById("senha");

const nomeInput = document.getElementById("nome");
const inicioInput = document.getElementById("inicio");
const fimInput = document.getElementById("fim");
const temFeriado = document.getElementById("temFeriado");
const qtdFeriado = document.getElementById("qtdFeriado");
const campoQtdFeriado = document.getElementById("campoQtdFeriado");
const retornoInput = document.getElementById("retorno");

const tabela = document.getElementById("tabela");
const listaPessoas = document.getElementById("listaPessoas");
const proximoDiv = document.getElementById("proximoFerias");
const filtroDisponivel = document.getElementById("filtroDisponivel");

/* ===== ESTADO ===== */
let isAdmin = localStorage.getItem("isAdmin") === "true";
let adminLogado = localStorage.getItem("adminLogado") || "";
let pessoas = JSON.parse(localStorage.getItem("ferias")) || [];
let indiceEdicao = null;
const coresPorPessoa = JSON.parse(localStorage.getItem("coresPorPessoa")) || {};
const feriasPorDia = {};

/* ===== EVENTOS ===== */
btnMostrarAdmin.onclick = () => {
    loginAdminDiv.style.display = "block";
    btnMostrarAdmin.style.display = "none";
};

document.getElementById("btnLogin").onclick = loginAdmin;
document.getElementById("btnLogout").onclick = logoutAdmin;
document.getElementById("btnSalvar").onclick = salvarFerias;
document.getElementById("btnCancelar").onclick = cancelarEdicao;

temFeriado.onchange = () => {
    campoQtdFeriado.style.display = temFeriado.value === "sim" ? "flex" : "none";
    calcularRetorno();
};
fimInput.onchange = calcularRetorno;
qtdFeriado.oninput = calcularRetorno;

filtroDisponivel.onchange = aplicarFiltro;

/* ===== LOGIN ===== */
function loginAdmin() {
    const u = usuario.value.trim().toLowerCase();
    const s = senha.value;

    const ok = ADMINS.find(a => a.user === u && a.pass === s);
    if (!ok) {
        statusLogin.innerText = "‚ùå Usu√°rio ou senha inv√°lidos";
        return;
    }

    isAdmin = true;
    adminLogado = u;
    localStorage.setItem("isAdmin", "true");
    localStorage.setItem("adminLogado", u);

    statusLogin.innerText = `‚úÖ Logado como ${u}`;
    renderizar();
}

function logoutAdmin() {
    isAdmin = false;
    adminLogado = "";

    localStorage.removeItem("isAdmin");
    localStorage.removeItem("adminLogado");

    loginAdminDiv.style.display = "none";
    btnMostrarAdmin.style.display = "block";
    statusLogin.innerText = "üîí Usu√°rio comum";

    renderizar();
}

/* ===== UTIL ===== */
function criarDataLocal(d) {
    const [a,m,di] = d.split("-");
    return new Date(a, m-1, di);
}

function formatarDataAbreviada(d) {
    const data = criarDataLocal(d);
    const dia = String(data.getDate()).padStart(2, "0");
    const mes = String(data.getMonth() + 1).padStart(2, "0");
    const ano = data.getFullYear();
    return `${dia}/${mes}/${ano}`;
}

function calcularRetorno() {
    if (!fimInput.value) return;

    let data = criarDataLocal(fimInput.value);
    if (temFeriado.value === "sim") {
        data.setDate(data.getDate() + Number(qtdFeriado.value || 0));
    }
    retornoInput.value = data.toISOString().split("T")[0];
}

function capitalizarNome(v) {
    return v.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
}

function corPessoa(nome) {
    if (!coresPorPessoa[nome]) {
        coresPorPessoa[nome] =
            "#" + Math.floor(Math.random()*16777215).toString(16);
        localStorage.setItem("coresPorPessoa", JSON.stringify(coresPorPessoa));
    }
    return coresPorPessoa[nome];
}

function corClara(hex) {
    const r = parseInt(hex.substr(1,2),16);
    const g = parseInt(hex.substr(3,2),16);
    const b = parseInt(hex.substr(5,2),16);
    return `rgba(${r},${g},${b},0.15)`;
}

/* ===== TABELA 730 DIAS ===== */
const hoje = new Date();
hoje.setHours(0,0,0,0);

for (let i = 0; i <= 730; i++) {
    const d = new Date(hoje);
    d.setDate(hoje.getDate() + i);
    const chave = d.toISOString().split("T")[0];
    feriasPorDia[chave] = [];

    const tr = document.createElement("tr");
    tr.dataset.data = chave;
    if (i === 0) tr.classList.add("hoje");

    tr.innerHTML = `
        <td>${d.toLocaleDateString("pt-BR")}</td>
        <td>${d.toLocaleDateString("pt-BR",{weekday:"long"})}</td>
        <td>Dispon√≠vel</td>`;
    tabela.appendChild(tr);
}

/* ===== A√á√ïES ===== */
function salvarFerias() {
    const nome = capitalizarNome(nomeInput.value.trim());
    const inicio = inicioInput.value;
    const fim = fimInput.value;

    if (!nome || !inicio || !fim) return alert("Preencha tudo");
    if (fim < inicio) return alert("Data final menor que inicial");

    calcularRetorno();

    const registro = {
        nome, inicio, fim,
        feriado: temFeriado.value === "sim",
        qtdFeriado: temFeriado.value === "sim" ? Number(qtdFeriado.value) : 0,
        retorno: retornoInput.value
    };

    if (indiceEdicao !== null) {
        if (!isAdmin) return alert("Somente admin");
        pessoas[indiceEdicao] = registro;
        indiceEdicao = null;
    } else {
        pessoas.push(registro);
    }

    localStorage.setItem("ferias", JSON.stringify(pessoas));
    renderizar();
    limpar();
}

function renderizar() {
    statusLogin.innerText = isAdmin ? `‚úÖ Admin: ${adminLogado}` : "üîí Usu√°rio comum";

    document.querySelectorAll("#tabela tr").forEach(tr => {
        tr.style.background = "";
        tr.cells[2].innerHTML = "Dispon√≠vel";
    });

    pessoas.forEach(p => {
        document.querySelectorAll("#tabela tr").forEach(tr => {
            if (tr.dataset.data >= p.inicio && tr.dataset.data <= p.fim) {
                tr.style.background = corClara(corPessoa(p.nome));

                // Acumula nomes sem sobrescrever
                const chip = `<span class="chip" style="background:${corPessoa(p.nome)}">${p.nome}</span>`;
                if (tr.cells[2].innerHTML.includes("F√âRIAS")) {
                    tr.cells[2].innerHTML += " " + chip;
                } else {
                    tr.cells[2].innerHTML = "F√âRIAS " + chip;
                }
            }
        });
    });

    listaPessoas.innerHTML = "";
    pessoas.forEach((p,i) => {
        listaPessoas.innerHTML += `
        <li>
            <span class="chip" style="background:${corPessoa(p.nome)}">${p.nome}</span>
            ${formatarDataAbreviada(p.inicio)} ‚Üí ${formatarDataAbreviada(p.fim)}
            | <b>Retorno:</b> ${formatarDataAbreviada(p.retorno)}
            ${isAdmin ? `<button onclick="editar(${i})">‚úèÔ∏è</button>
                         <button onclick="excluir(${i})">‚ùå</button>` : ""}
        </li>`;
    });

    atualizarProximos();
    aplicarFiltro(); // Aplica filtro sempre que renderiza
}

function editar(i) {
    if (!isAdmin) return;
    const p = pessoas[i];
    indiceEdicao = i;
    nomeInput.value = p.nome;
    inicioInput.value = p.inicio;
    fimInput.value = p.fim;
    temFeriado.value = p.feriado ? "sim" : "nao";
    qtdFeriado.value = p.qtdFeriado || 1;
    campoQtdFeriado.style.display = p.feriado ? "flex" : "none";
    retornoInput.value = p.retorno;
}

function excluir(i) {
    if (!isAdmin) return;
    if (confirm("Excluir f√©rias?")) {
        pessoas.splice(i,1);
        localStorage.setItem("ferias", JSON.stringify(pessoas));
        renderizar();
    }
}

function atualizarProximos() {
    const futuras = pessoas.filter(p => criarDataLocal(p.inicio) >= hoje);
    const grupos = {};
    futuras.forEach(p => {
        if (!grupos[p.inicio]) grupos[p.inicio] = [];
        grupos[p.inicio].push(p.nome);
    });

    proximoDiv.innerHTML = Object.keys(grupos).slice(0,3).map(d => `
        <div class="proximo-card">
            ${grupos[d].map(n =>
                `<span class="chip" style="background:${corPessoa(n)}">${n}</span>`
            ).join("")}
            <div><b>üìÖ ${criarDataLocal(d).toLocaleDateString("pt-BR")}</b></div>
        </div>`).join("");
}

function cancelarEdicao() {
    indiceEdicao = null;
    limpar();
}

function limpar() {
    nomeInput.value = inicioInput.value = fimInput.value = retornoInput.value = "";
    temFeriado.value = "nao";
    campoQtdFeriado.style.display = "none";
}

/* ===== FILTRO ===== */
function aplicarFiltro() {
    const valor = filtroDisponivel.value;

    document.querySelectorAll("#tabela tr").forEach(tr => {
        if (valor === "todos") {
            tr.style.display = "";
        } else if (valor === "disponivel") {
            tr.style.display = tr.cells[2].innerText.trim() === "Dispon√≠vel" ? "" : "none";
        } else if (valor === "ferias") {
            tr.style.display = tr.cells[2].innerText.trim() !== "Dispon√≠vel" ? "" : "none";
        }
    });
}

/* INIT */
renderizar();

if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
